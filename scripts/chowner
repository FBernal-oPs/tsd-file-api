#!/bin env python

"""
Called with sudo as a sub-process by the file-api once the file
is written, to set the file owner to the identity of the authenticated
user.

subprocess.call(['sudo', '/bin/chowner', 'path-to-file', 'username'])

Setup
-----
visudo -f /etc/sudoers.d/<fileapiuser>

Defaults:fileapi            !requiretty
fileapi ALL = (ALL) NOPASSWD: <path/to/executable>

"""

from sys import argv
import os
import pwd
import re

IS_VALID_USERNAME = re.compile(r'p+[0-9]+-[a-z]')

def change_owner(path, username):
    """
    The default group is pXX-member-group.
    If we want to support user-chosen group ownership
    then we can enable that here via custom headers, e.g.
    """
    try:
        user = pwd.getpwnam(username).pw_uid
        group = os.stat(path).st_gid
    except Exception:
        return False
    os.chown(path, user, group)
    return True

def main():
    path = os.path.normpath(argv[1])
    username = argv[2]
    assert os.path.isabs(path)
    assert IS_VALID_USERNAME.match(username)
    assert change_owner(path, username)
    return

if __name__ == '__main__':
    main()
